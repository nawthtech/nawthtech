name: NawthTech CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  GO_VERSION: '1.25.4'
  NODE_VERSION: '22.x'

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend/go.sum

    - name: Verify Go environment
      run: |
        go version
        echo "GOPATH: $GOPATH"
        echo "GOROOT: $GOROOT"

    - name: Download dependencies
      run: |
        go mod download
        go mod verify
        go mod tidy
        echo "âœ… Dependencies downloaded and verified"

    - name: Run tests
      run: |
        go test -v ./... -race -coverprofile=coverage.out
        echo "âœ… Tests completed successfully"

    - name: Check Go code formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "âŒ Code formatting issues found. Please run 'gofmt -w .' to fix."
          gofmt -l .
          exit 1
        else
          echo "âœ… Code formatting check passed"
        fi

    - name: Build Go binary
      run: |
        go build -v -o nawthtech-backend .
        echo "âœ… Backend binary built successfully"

    - name: Test binary execution
      run: |
        if [ -f "nawthtech-backend" ]; then
          echo "âœ… Binary created successfully"
          ls -lah nawthtech-backend
          # Ø§Ø®ØªØ¨Ø§Ø± ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹
          timeout 5s ./nawthtech-backend --help || true
        else
          echo "âŒ Binary creation failed"
          exit 1
        fi

    - name: Upload backend binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-binary
        path: backend/nawthtech-backend
        retention-days: 1

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.out
        flags: unittests
        name: backend-coverage

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Verify Node.js environment
      run: |
        node --version
        npm --version

    - name: Install dependencies
      run: |
        npm install --no-audit --no-fund --prefer-offline
        echo "âœ… Frontend dependencies installed"

    - name: Run type checking
      run: |
        npx tsc --noEmit || true
        echo "âœ… TypeScript compilation check completed"

    - name: Run linting
      run: |
        npx eslint . --ext ts,tsx --quiet
        echo "âœ… ESLint check completed"

    - name: Run tests
      run: |
        npm test
        echo "âœ… Frontend tests completed"

    - name: Build frontend
      run: |
        npm run build
        echo "âœ… Frontend built successfully"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 1

  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Go security check
      run: |
        cd backend
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || true
        echo "âœ… Security vulnerability check completed"

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level moderate || true
        echo "âœ… NPM audit completed"

  notify:
    runs-on: ubuntu-latest
    needs: [backend, frontend, security]
    if: always()
    
    steps:
    - name: Summary Status
      run: |
        echo "ğŸ“Š NawthTech CI/CD Summary"
        echo "=========================="
        echo "Backend: ${{ needs.backend.result }}"
        echo "Frontend: ${{ needs.frontend.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo ""
        if [[ "${{ needs.backend.result }}" == "success" && "${{ needs.frontend.result }}" == "success" && "${{ needs.security.result }}" == "success" ]]; then
          echo "âœ… All checks passed! Railway will automatically deploy from GitHub."
          echo ""
          echo "ğŸš€ Deployment will be triggered automatically by Railway:"
          echo "- Backend: https://nawthtech-backend-production.up.railway.app"
          echo "- Frontend: https://nawthtech-frontend-production.up.railway.app"
        else
          echo "âŒ Some checks failed. Fix issues before merging to main."
        fi

    - name: Send notification (optional)
      if: failure()
      run: |
        echo "Workflow failed! Check the logs for details."
        # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§ (Slack, Discord, Email, etc.)