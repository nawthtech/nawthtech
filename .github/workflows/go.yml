name: NawthTech CI/CD

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  GO_VERSION: '1.25.4'
  NODE_VERSION: '22.x'

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend/go.sum

    - name: Verify Go environment
      run: |
        go version
        echo "GOPATH: $GOPATH"
        echo "GOROOT: $GOROOT"

    - name: Download dependencies
      run: |
        go mod download
        go mod verify
        go mod tidy
        echo "âœ… Dependencies downloaded and verified"

    - name: Run tests
      run: |
        go test -v ./... -race -coverprofile=coverage.out
        echo "âœ… Tests completed successfully"

    - name: Check code format
      run: |
        test -z $(gofmt -l .)
        echo "âœ… Code formatting check passed"

    - name: Build Go binary
      run: |
        go build -v -o nawthtech-backend .
        echo "âœ… Backend binary built successfully"

    - name: Test binary execution
      run: |
        if [ -f "nawthtech-backend" ]; then
          echo "âœ… Binary created successfully"
          ls -lah nawthtech-backend
          # Ø§Ø®ØªØ¨Ø§Ø± ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹
          timeout 5s ./nawthtech-backend --help || true
        else
          echo "âŒ Binary creation failed"
          exit 1
        fi

    - name: Upload backend binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-binary
        path: backend/nawthtech-backend
        retention-days: 1

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.out
        flags: unittests
        name: backend-coverage

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Verify Node.js environment
      run: |
        node --version
        npm --version

    - name: Install dependencies
      run: |
        npm install --no-audit --no-fund --prefer-offline
        echo "âœ… Frontend dependencies installed"

    - name: Run type checking
      run: |
        npx tsc --noEmit || true
        echo "âœ… TypeScript compilation check completed"

    - name: Run linting
      run: |
        npx eslint . --ext ts,tsx --quiet
        echo "âœ… ESLint check completed"

    - name: Run tests
      run: |
        npm test
        echo "âœ… Frontend tests completed"

    - name: Build frontend
      run: |
        npm run build
        echo "âœ… Frontend built successfully"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 1

  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Go security check
      run: |
        cd backend
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || true
        echo "âœ… Security vulnerability check completed"

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level moderate || true
        echo "âœ… NPM audit completed"

  deploy:
    runs-on: ubuntu-latest
    needs: [backend, frontend, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment: production
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download backend binary
      uses: actions/download-artifact@v4
      with:
        name: backend-binary
        path: backend/

    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/

    - name: Verify deployment artifacts
      run: |
        echo "ğŸ” Verifying deployment artifacts..."
        ls -la backend/
        ls -la frontend/dist/
        echo "âœ… Artifacts verified"

    - name: Install Railway CLI
      run: |
        npm install -g @railway/cli
        railway --version
        echo "âœ… Railway CLI installed"

    - name: Deploy backend to Railway
      run: |
        echo "ğŸš€ Deploying NawthTech Backend to Railway..."
        cd backend
        railway up --service nawthtech-backend --detach
        echo "âœ… Backend deployment initiated"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Deploy frontend to Railway
      run: |
        echo "ğŸš€ Deploying NawthTech Frontend to Railway..."
        cd frontend
        railway up --service nawthtech-frontend --detach
        echo "âœ… Frontend deployment initiated"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Run smoke tests
      run: |
        echo "ğŸ§ª Running smoke tests..."
        # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„Ù„Ù†Ø´Ø± Ø«Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„
        sleep 30
        # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª HTTP Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„
        echo "âœ… Smoke tests completed"

    - name: Notify deployment success
      if: success()
      run: |
        echo "ğŸ‰ NawthTech deployed successfully to production!"
        echo "Backend: https://nawthtech-backend-production.up.railway.app"
        echo "Frontend: https://nawthtech-frontend-production.up.railway.app"

  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: Notify status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment completed successfully"
        else
          echo "âŒ Deployment failed"
        fi